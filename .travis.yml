language: python
dist: xenial
cache: pip
addons:
  apt:
    packages:
    - libsnappy-dev
services:
  - redis-server

stages:
  - name: test
  - name: deploy
    if: tag IS present

python:
  - "3.8"
os:
  - linux

matrix:
  fast_finish: true

install:
  - pip install -U setuptools pip
  - pip install -U -e ".[build,dev,test,zeromq,redis,thrift,snappy]"
script:
  - python -m mypy src examples
  - python -m flake8 src tests examples
  - python -m pytest tests
  - ./scripts/run-integration-tests.sh
after_success:
  - codecov

# stage def.
jobs:
  include:

    - stage: test

    - stage: deploy
      python: "3.8"
      script: skip
      after_script: skip
      deploy:
        on:
          tags: true
        provider: pypi
        distributions: sdist bdist_wheel
        skip_upload_docs: true
        user: __token__
        password:
          secure: "ufb7FwCCKVaj2RLWhSUO6cNzy/0z07SrP1hLHbunPQh2Dgz/CzlpO1XJIo7qWoFEW1rl65NbEuFV2bXEBz4TKrBgVANNKkHViY9haHY1tdN6Lf3Dbup4lx7vChupK600YrjXrKKP/mN9qfV3eCMVGbIuqv8P9BhR9vbbyi0myqKwC2ljKpupFwSz3U/dbUIbK8Mm/upkZpcjGgCSeT27aOCKieMQOabEfCfi75891UBKZ/7MqqLcrrc21ls6+7YzqWVEfBnpBhQkiWWbRZ0N3UJj8Yd4k3YB2zHHsi+1mVnRX6VrWlNYPZe0EHEg5cJtYt/dijlJI4sZ7EwGiOGn+UvLoCB8QD26Knt9RRzZjDHzasos5a+9YCEEuF2KLfLZgvaHRfHuTtXxqJxra0PHKUzXuaSXFU+6BRFmYOuMvcRjKj3CiTGS9/nZ8ic0zVvkO+etG0rjwuUfYO4LtZrcPq+KJeciQ+fLXR18TUWuDIpeE5sIomgKKbnw1WWFNujz3kcEdtxmCxmHZFYuQRFF1I8MxU4v3NtQ7Bdf6tiEHmEViY4C06nXFSmbjk1Ivq/naTNZJC80CdcqktN6SGTieiWXEBqFgV/ZWTbyEQ3lZkZVLeTzUM5n3seXFUak8Diy+TVP4ctADsSXsqWGViB3oQaDfcp0ijSo5TEdhzg1j88="

  exclude:
    # exclude the redundant default job
    - python: "3.8"


notifications:
  email: false
